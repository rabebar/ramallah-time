<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script>
    // منع ظهور الصفحة قبل التحقق
    document.documentElement.style.display = 'none';

    (async function verifyAccess() {
        const token = sessionStorage.getItem("admin_token");
        
        if (!token) {
            window.location.replace("/static/admin-login.html");
            return;
        }

        try {
            const res = await fetch("/api/admin/verify", {
                headers: { "x-admin-token": token }
            });

            if (res.ok) {
                // الكود صحيح، أظهر الصفحة الآن
                document.documentElement.style.display = 'block';
            } else {
                throw new Error();
            }
        } catch (err) {
            sessionStorage.removeItem("admin_token");
            window.location.replace("/static/admin-login.html");
        }
    })();
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة الإدارة المالية | Ramallah Time</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
    }

    body {
      background: var(--bg); font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0; color: var(--text); overflow-x: hidden;
      display: flex; min-height: 100vh;
    }

    /* الشريط الجانبي - Sidebar */
    .sidebar {
      width: 260px; background: var(--card); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; position: fixed; height: 100vh; right: 0;
    }
    .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
    .sidebar-menu { padding: 20px 0; flex-grow: 1; }
    .menu-item {
      padding: 15px 25px; display: flex; align-items: center; gap: 15px;
      color: var(--text-dim); text-decoration: none; font-weight: 700; transition: 0.3s;
    }
    .menu-item:hover, .menu-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); border-right: 4px solid var(--primary); }
    .logout-box { padding: 20px; border-top: 1px solid var(--border); }

    /* المنطقة الرئيسية */
    .main-content { margin-right: 260px; flex-grow: 1; padding: 30px; }

    /* كروت الإحصائيات */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card {
      background: var(--card); padding: 25px; border-radius: 20px;
      border: 1px solid var(--border); position: relative; overflow: hidden;
    }
    .stat-card::after {
      content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; opacity: 0.5;
    }
    .stat-blue::after { background: var(--primary); }
    .stat-green::after { background: var(--success); }
    .stat-gold::after { background: var(--warning); }
    .stat-red::after { background: var(--danger); }

    .stat-val { font-size: 32px; font-weight: 900; margin-bottom: 5px; }
    .stat-label { color: var(--text-dim); font-size: 14px; font-weight: 700; }
    .stat-icon { position: absolute; left: 20px; top: 20px; font-size: 40px; opacity: 0.1; }

    /* الجداول المتقدمة */
    .table-container { background: var(--card); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
    .table-header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th { background: rgba(255,255,255,0.02); padding: 18px 25px; text-align: right; color: var(--text-dim); font-size: 13px; font-weight: 800; }
    td { padding: 18px 25px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 700; }
    
    .badge { padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 900; }
    .bg-pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .bg-active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .bg-expired { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

    /* البحث */
    .search-box {
      background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; width: 300px;
    }
    .search-box input { background: transparent; border: none; color: white; outline: none; font-family: inherit; width: 100%; }

    /* النوافذ المنبثقة */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px);
    }
    .modal-content { background: var(--card); padding: 35px; border-radius: 28px; width: 90%; max-width: 450px; border: 1px solid var(--border); }
    .modal-input { width: 100%; height: 55px; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 0 15px; margin-bottom: 15px; font-family: inherit; }
  </style>
</head>
<body>

  <!-- الشريط الجانبي (Sidebar) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2 style="color: var(--primary); font-weight: 900; margin: 0;">الإدارة المالية</h2>
      <p style="font-size: 12px; color: var(--text-dim); margin: 5px 0 0;">Ramallah Time — Admin</p>
    </div>
    
    <nav class="sidebar-menu">
      <a href="/" class="menu-item"><i class="fa-solid fa-house"></i> العودة للموقع</a>
      <a href="#" class="menu-item active"><i class="fa-solid fa-chart-pie"></i> لوحة الإحصائيات</a>
      <a href="#" onclick="loadData()" class="menu-item"><i class="fa-solid fa-sync"></i> تحديث البيانات</a>
    </nav>

    <div class="logout-box">
      <button onclick="logout()" style="width:100%; padding:12px; background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid var(--danger); border-radius:12px; cursor:pointer; font-weight:800; font-family:inherit;">
        <i class="fa-solid fa-power-off"></i> تسجيل خروج
      </button>
    </div>
  </aside>

  <!-- المنطقة الرئيسية (Main Content) -->
  <main class="main-content">
    
    <!-- كروت الإحصائيات العلوية -->
    <div class="stats-grid">
      <div class="stat-card stat-blue">
        <i class="fa-solid fa-dollar-sign stat-icon"></i>
        <div class="stat-val" id="totalRevenue" style="color: var(--primary);">$0</div>
        <div class="stat-label">إجمالي التحصيل المالي</div>
      </div>
      
      <div class="stat-card stat-green">
        <i class="fa-solid fa-check-double stat-icon"></i>
        <div class="stat-val" id="countActive" style="color: var(--success);">0</div>
        <div class="stat-label">اشتراكات نشطة حالياً</div>
      </div>
      
      <div class="stat-card stat-gold">
        <i class="fa-solid fa-clock-rotate-left stat-icon"></i>
        <div class="stat-val" id="countPending" style="color: var(--warning);">0</div>
        <div class="stat-label">طلبات بانتظار التفعيل</div>
      </div>

      <div class="stat-card stat-red">
        <i class="fa-solid fa-calendar-xmark stat-icon"></i>
        <div class="stat-val" id="countExpired" style="color: var(--danger);">0</div>
        <div class="stat-label">اشتراكات منتهية</div>
      </div>
    </div>

    <!-- حاوية الجدول الرئيسي -->
    <div class="table-container">
      <div class="table-header">
        <h3 style="margin:0; font-weight:900;">قائمة إدارة المنشآت</h3>
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--text-dim);"></i>
          <input type="text" id="adminSearch" placeholder="ابحث باسم المكان أو الهاتف..." oninput="renderData()">
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table id="placesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>المنشأة والمالك</th>
              <th>الحالة</th>
              <th>تاريخ الانتهاء</th>
              <th>المجموع المالي</th>
              <th>إجراءات إدارية</th>
            </tr>
          </thead>
          <tbody id="placesList">
            <!-- سيتم تعبئة البيانات هنا برمجياً -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- نافذة التفعيل والقبض المالي (Activation Modal) -->
  <div id="activateModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top:0; color:var(--primary); font-weight:900;">تفعيل / تجديد اشتراك</h2>
      <p style="color:var(--text-dim); font-size:14px; margin-bottom:25px;">قم بتحديد المدة والمبلغ المستلم من العميل.</p>
      
      <input type="hidden" id="targetId">
      
      <label class="stat-label" style="display:block; margin-bottom:8px;">مدة الاشتراك:</label>
      <select id="subMonths" class="modal-input">
        <option value="1">شهر واحد (تجريبي)</option>
        <option value="3">3 شهور (فصلي)</option>
        <option value="6">6 شهور (نصف سنوي)</option>
        <option value="12" selected>12 شهر (سنة كاملة)</option>
      </select>
      
      <label class="stat-label" style="display:block; margin-bottom:8px;">المبلغ المقبوض ($):</label>
      <input type="number" id="subAmount" class="modal-input" placeholder="مثلاً: 100">
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="confirmActivation()" style="flex:2; height:50px; background:var(--success); border:none; border-radius:12px; font-weight:900; cursor:pointer;">تأكيد وقبض المال</button>
        <button onclick="closeModal()" style="flex:1; height:50px; background:transparent; border:1px solid var(--border); color:var(--text-dim); border-radius:12px; cursor:pointer;">إلغاء</button>
      </div>
    </div>
  </div>
  <script>
    (async function verifyAccess() {
    const token = sessionStorage.getItem("admin_token");
    if (!token) {
        window.location.href = "/static/admin-login.html";
        return;
    }

    // التحقق من صحة الكود مع السيرفر
    const res = await fetch("/api/admin/verify", {
        headers: { "x-admin-token": token }
    });

    if (!res.ok) {
        alert("انتهت صلاحية الجلسة أو الكود خاطئ.");
        sessionStorage.removeItem("admin_token");
        window.location.href = "/static/admin-login.html";
    }
})();
    "use strict";

    // 1. استرجاع كود الأمان الخاص بالأدمن من المتصفح
    const adminToken = sessionStorage.getItem("admin_token");
    let allPlaces = [];

    // التحقق: إذا لم يكن هناك توكن، نعيده لصفحة الدخول
    if (!adminToken) {
        window.location.href = "/owner-login";
    }

    /**
     * 2. جلب البيانات من السيرفر:
     * نطلب كل الأماكن بما فيها المخفية (المعلقة والمنتهية).
     */
    async function loadData() {
        try {
            const res = await fetch("/api/places?limit=1000&include_hidden=true", {
                headers: { "x-admin-token": adminToken }
            });

            if (res.status === 401) {
                alert("انتهت الجلسة أو الكود خطأ.");
                logout();
                return;
            }

            const data = await res.json();
            allPlaces = data.items || [];
            
            calculateStats();
            renderData();
        } catch (e) {
            console.error("خطأ في جلب البيانات:", e);
        }
    }

    /**
     * 3. معالجة الإحصائيات المالية والإدارية:
     */
    function calculateStats() {
        let revenue = 0;
        let active = 0;
        let pending = 0;
        let expired = 0;

        allPlaces.forEach(p => {
            // تحويل القيمة لرقم لضمان عدم حدوث خطأ نصي أثناء الجمع
            revenue += Number(p.payment_total || 0);
            
            if (p.subscription_status === 'pending') {
                pending++;
            } else if (p.is_expired) {
                expired++;
            } else {
                active++;
            }
        });

        // تحديث الأرقام في الواجهة مع إضافة الفاصلة العشرية للمبلغ
        document.getElementById("totalRevenue").innerText = "$" + revenue.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById("countActive").innerText = active;
        document.getElementById("countPending").innerText = pending;
        document.getElementById("countExpired").innerText = expired;
    }

    /**
     * 4. عرض البيانات في الجدول مع دعم البحث:
     */
    function renderData() {
        const tbody = document.getElementById("placesList");
        const searchTerm = document.getElementById("adminSearch").value.toLowerCase();
        tbody.innerHTML = "";

        const filtered = allPlaces.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            (p.phone && p.phone.includes(searchTerm))
        );

        filtered.forEach(p => {
            let statusBadge = `<span class="badge bg-active">نشط</span>`;
            let btnText = "تجديد"; // النص الافتراضي للمشتركين
            
            if (p.subscription_status === 'pending') {
                statusBadge = `<span class="badge bg-pending">طلب جديد</span>`;
                btnText = "تفعيل وقبض"; // النص للطلبات الجديدة
            } else if (p.is_expired) {
                statusBadge = `<span class="badge bg-expired">منتهي</span>`;
                btnText = "إعادة تفعيل";
            }

            const endDate = p.subscription_end ? new Date(p.subscription_end).toLocaleDateString('ar-EG') : "لم يحدد";

            tbody.innerHTML += `
                <tr>
                    <td>#${p.id}</td>
                    <td>
                        <div style="font-weight:900;">${p.name}</div>
                        <div style="font-size:12px; color:var(--text-dim);">${p.owner_email || 'بدون إيميل'}</div>
                    </td>
                    <td>${statusBadge}</td>
                    <td style="font-size:13px;">${endDate}</td>
                    <td style="color:var(--success); font-weight:900;">$${(p.payment_total || 0).toFixed(2)}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <button onclick="openModal(${p.id})" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:800;">${btnText}</button>
                            <button onclick="deletePlace(${p.id})" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:6px 12px; border-radius:8px; cursor:pointer;">حذف</button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    /**
     * 5. عمليات التفعيل والدفع المالي:
     */
    function openModal(id) {
        document.getElementById("targetId").value = id;
        document.getElementById("activateModal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("activateModal").style.display = "none";
    }

    async function confirmActivation() {
        const id = document.getElementById("targetId").value;
        const months = document.getElementById("subMonths").value;
        const amount = document.getElementById("subAmount").value;

        if (!amount) return alert("يرجى إدخال المبلغ المستلم");

        try {
            const res = await fetch(`/api/places/${id}/activate`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "x-admin-token": adminToken 
                },
                body: JSON.stringify({ months: parseInt(months), amount: parseFloat(amount) })
            });

            if (res.ok) {
                alert("✅ تم تفعيل الاشتراك واستلام المبلغ بنجاح.");
                closeModal();
                loadData();
            } else {
                alert("فشل التفعيل. تأكد من الصلاحيات.");
            }
        } catch (e) {
            alert("خطأ في الاتصال بالسيرفر.");
        }
    }

    /**
     * 6. حذف مكان نهائياً:
     */
    async function deletePlace(id) {
        if (!confirm("هل أنت متأكد من حذف هذا المكان نهائياً؟ لا يمكن التراجع.")) return;
        
        try {
            const res = await fetch(`/api/places/${id}`, {
                method: "DELETE",
                headers: { "x-admin-token": adminToken }
            });
            if (res.ok) {
                loadData();
            }
        } catch (e) {
            alert("خطأ أثناء الحذف.");
        }
    }

    function logout() {
        sessionStorage.removeItem("admin_token");
        window.location.href = "/owner-login";
    }

    // تشغيل الجلب التلقائي عند فتح الصفحة
    window.onload = loadData;
  </script>
</body>
</html>